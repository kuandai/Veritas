name: security-srp

on:
  pull_request:
  push:
    branches:
      - main
  schedule:
    - cron: "30 6 * * *"
  workflow_dispatch:

jobs:
  strict-srp:
    runs-on: ubuntu-24.04
    env:
      CONAN_HOME: ${{ github.workspace }}/.conan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Conan
        run: |
          python -m pip install --upgrade pip
          python -m pip install "conan>=2.0,<3.0"

      - name: Bootstrap Conan recipes
        run: ./scripts/bootstrap.sh

      - name: Generate lockfile
        run: ./scripts/lock.sh

      - name: Build with proto tests enabled
        env:
          VERITAS_ENABLE_PROTO_TESTS: ON
          BUILD_TYPE: Debug
        run: ./scripts/build.sh

      - name: Run strict SRP suite
        env:
          VERITAS_STRICT_SRP: ON
        run: ./scripts/test.sh

      - name: Upload SRP verification artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: srp-strict-artifacts
          path: build/security-artifacts/srp-strict
          if-no-files-found: warn

  revocation-integration:
    runs-on: ubuntu-24.04
    env:
      CONAN_HOME: ${{ github.workspace }}/.conan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Conan
        run: |
          python -m pip install --upgrade pip
          python -m pip install "conan>=2.0,<3.0"

      - name: Bootstrap Conan recipes
        run: ./scripts/bootstrap.sh

      - name: Generate lockfile
        run: ./scripts/lock.sh

      - name: Build with proto tests enabled
        env:
          VERITAS_ENABLE_PROTO_TESTS: ON
          BUILD_TYPE: Debug
        run: ./scripts/build.sh

      - name: Run revocation integration suite
        run: ctest --test-dir build --output-on-failure -R veritas_libveritas_tests

  notary-lifecycle:
    runs-on: ubuntu-24.04
    env:
      CONAN_HOME: ${{ github.workspace }}/.conan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Conan
        run: |
          python -m pip install --upgrade pip
          python -m pip install "conan>=2.0,<3.0"

      - name: Bootstrap Conan recipes
        run: ./scripts/bootstrap.sh

      - name: Generate lockfile
        run: ./scripts/lock.sh

      - name: Build with proto tests enabled
        env:
          VERITAS_ENABLE_PROTO_TESTS: ON
          BUILD_TYPE: Debug
        run: ./scripts/build.sh

      - name: Run notary lifecycle suite
        run: ctest --test-dir build --output-on-failure -R veritas_notary_tests

  tsan-nightly:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04
    env:
      CONAN_HOME: ${{ github.workspace }}/.conan
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Conan
        run: |
          python -m pip install --upgrade pip
          python -m pip install "conan>=2.0,<3.0"

      - name: Bootstrap Conan recipes
        run: ./scripts/bootstrap.sh

      - name: Configure TSAN build
        run: |
          conan install . -of build_tsan -s build_type=Debug --build=missing
          cmake -S . -B build_tsan \
            -DCMAKE_TOOLCHAIN_FILE=build_tsan/conan_toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Debug \
            -DVERITAS_ENABLE_PROTO_TESTS=ON \
            -DCMAKE_CXX_FLAGS="-fsanitize=thread -fno-omit-frame-pointer" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread" \
            -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=thread"

      - name: Build TSAN targets
        run: cmake --build build_tsan --parallel

      - name: Run TSAN lifecycle/session/notary tests
        env:
          TSAN_OPTIONS: "suppressions=${{ github.workspace }}/tests/tsan-grpc.supp halt_on_error=1"
        run: ctest --test-dir build_tsan --output-on-failure -R "veritas_gatekeeper_tests|veritas_libveritas_tests|veritas_notary_tests"
